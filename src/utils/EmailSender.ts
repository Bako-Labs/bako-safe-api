import cheerio from 'cheerio';
import fs from 'fs';
import handlebars from 'handlebars';
import nodemailer, { SendMailOptions } from 'nodemailer';
import path from 'path';

const { AWS_SMTP_USER, AWS_SMTP_PASS, EMAIL_FROM } = process.env;

// TO DO: pass logo to bank settings
// const LOGO = `<svg width="160" height="27" viewBox="0 0 160 27" fill="none" xmlns="http://www.w3.org/2000/svg">
// <path fill-rule="evenodd" clip-rule="evenodd" d="M0 14.2697C0 17.1417 0.969156 19.792 2.63446 21.8908C4.64696 24.4271 7.96907 26.3325 11.3157 26.3325C13.6156 26.3325 15.0622 26.1468 17.0285 25.1564C17.7284 24.8041 18.2113 24.5238 18.8129 24.0702C19.7176 23.426 20.2852 22.894 21.0402 21.9499C22.7001 19.8292 23.6975 17.186 23.6975 14.2697C23.6526 12.4709 23.2326 11.4897 23.2308 11.4916L21.5655 13.285C21.5655 14.1477 21.5925 15.0076 21.4888 15.7521C21.3783 16.5463 21.2079 17.1132 20.982 17.7888C20.6712 18.7188 20.2117 19.5214 19.6451 20.3077C18.7555 21.5424 17.5019 22.587 16.1275 23.2701C12.9797 24.8347 9.32894 24.5183 6.49397 22.6237C5.00726 21.6301 4.19171 20.5951 3.32685 19.1464C1.81377 16.6121 1.73647 12.7572 3.06033 10.1111C4.06426 8.10432 5.62843 6.33647 7.70867 5.40818C13.2405 2.9397 17.3115 6.32275 17.7786 6.44759L19.1616 4.94056C18.33 4.3352 16.9772 3.47434 15.775 3.07841C12.547 2.01531 10.1084 2.16759 7.03999 3.42607C5.64315 3.99907 4.49872 4.8855 3.50544 5.87923C1.67944 7.70609 0 10.656 0 14.2697V14.2697ZM23.0032 2.19212C23.4253 2.26374 23.9727 2.41566 25.0476 2.62514L23.267 4.5408C22.6593 5.14899 22.1118 5.69701 21.504 6.30513C20.6705 7.13936 11.4083 16.5064 10.9877 16.7882L9.97336 15.7624L5.70465 11.4897L3.91586 13.2397L10.9674 20.3372C11.5244 19.9562 26.7399 4.47732 26.8349 4.41375C26.972 5.2682 27.1026 6.08148 27.1763 6.54048C27.486 5.57466 28.9386 1.14499 29.2732 0C27.1885 0.724876 25.0137 1.53377 23.0032 2.19212V2.19212Z" fill="#FF0305"/>
// <path fill-rule="evenodd" clip-rule="evenodd" d="M70.0615 15.4284H70.1151H75.6918H83.8581V12.9226L70.1865 12.9221C69.94 12.9221 69.7148 12.868 69.5397 12.8002C68.9808 12.5838 68.6487 12.1636 68.5427 11.581C68.4325 10.9756 68.4835 10.2877 68.8308 9.79604C69.0852 9.4359 69.6484 9.19408 70.0788 9.18945L71.9503 9.19012C75.9195 9.19012 79.8888 9.19012 83.8581 9.19012V6.68429H70.1155C69.0952 6.6842 67.9887 6.97158 67.2236 7.58199L66.918 7.845C66.4237 8.36596 66.1072 9.0113 65.9858 9.7231C65.9672 9.83234 65.9437 9.95841 65.9423 10.0662L65.9243 11.9063C65.9241 12.0496 65.9438 12.1287 65.9425 12.2565C65.9412 12.3971 65.9921 12.8411 66.0323 12.9226H52.1278V6.68426H49.5556C49.5556 10.6328 49.5556 14.5814 49.5556 18.53C49.5556 19.5134 49.5723 20.5104 49.5549 21.4921C49.5513 21.6946 49.5594 21.6505 49.7713 21.6492L51.6601 21.6492C51.7807 21.6492 51.9227 21.6564 52.0401 21.6514C52.1626 21.6462 52.1278 21.6243 52.1278 21.3513C52.1275 19.377 52.1278 17.4027 52.1278 15.4284H62.5426C62.9623 15.4284 65.8696 15.3914 66.0143 15.4459C65.9776 15.4777 66.0078 15.4405 65.9956 15.4972C65.8982 15.9471 65.9249 17.4288 65.9243 17.9167C65.9213 20.3247 67.7324 21.6278 70.1341 21.6311C70.258 21.6312 70.3476 21.6494 70.4932 21.6492H83.8581V19.1434H70.9069C70.3362 19.1434 69.6804 19.1717 69.2338 18.8807C68.7925 18.5932 68.5753 18.2132 68.5176 17.686C68.4723 17.2724 68.4945 16.8773 68.5901 16.5359C68.678 16.2215 68.8529 15.9395 69.0871 15.7584C69.2951 15.5975 69.6927 15.4284 70.0615 15.4284ZM106.792 9.13755C106.792 9.22537 107.112 9.1901 107.278 9.1901H119.726C120.284 9.1901 120.707 9.13288 121.203 9.32754C121.931 9.61263 122.172 10.3084 122.172 11.0301C122.172 11.43 122.092 11.8108 121.92 12.1343C121.639 12.6652 121.018 12.9226 120.391 12.9226H106.792V21.5966C106.792 21.637 106.805 21.6492 106.846 21.6492H109.311C109.352 21.6492 109.365 21.637 109.365 21.5966V15.4284H120.193C120.855 15.4284 121.48 15.3549 121.985 15.1942C122.123 15.1505 122.228 15.1082 122.352 15.0604L122.873 14.8143C123.523 14.4493 123.895 14.0525 124.28 13.4341C124.345 13.3294 124.391 13.2213 124.443 13.1027C124.557 12.8467 124.661 12.4929 124.705 12.168C124.753 11.8078 124.767 11.3631 124.766 11.0001C124.765 10.6464 124.748 10.2311 124.704 9.88009C124.622 9.22971 124.32 8.5899 123.953 8.12086C123.805 7.93231 123.639 7.78861 123.462 7.63506C123.283 7.47907 123.097 7.37656 122.884 7.25238C122.27 6.89564 121.246 6.68426 120.499 6.68426H106.792V9.13755ZM86.3764 14.009C86.3764 15.6326 86.5224 17.2412 87.3468 18.6361C87.6988 19.2316 88.1381 19.7243 88.6966 20.1424C88.749 20.1816 88.7971 20.211 88.8536 20.2522C89.0842 20.4205 89.5874 20.7016 89.8505 20.8056C90.6719 21.1301 90.9493 21.2243 91.8882 21.3965C93.095 21.6177 94.4291 21.6492 95.8559 21.6492H104.238C104.28 21.6492 104.292 21.637 104.292 21.5966V19.1433C101.182 19.1433 98.0245 19.1263 94.9203 19.1436L93.2805 19.0238C93.0753 18.9955 92.8782 18.9662 92.683 18.9224C91.9798 18.7646 91.2465 18.5332 90.6782 18.1243C90.5284 18.0165 90.4272 17.9467 90.2932 17.816L89.9519 17.465C89.902 17.4098 89.8496 17.3389 89.8047 17.2755C89.6411 17.0449 89.5368 16.8623 89.4166 16.6022C88.8346 15.342 88.8064 13.1588 89.3865 11.8947C89.5562 11.5247 89.75 11.1708 90.0139 10.8762L90.1761 10.7014C90.7159 10.1045 91.5359 9.69615 92.3265 9.5018C93.0964 9.31257 93.8788 9.1901 94.7047 9.1901H101.72V10.4693H104.292V6.68426H94.6687C94.0154 6.68426 93.4192 6.74428 92.834 6.80692C92.2799 6.86621 91.6749 6.9903 91.1853 7.12843C91.0528 7.16584 90.943 7.19624 90.8123 7.23816C90.2411 7.42139 89.6261 7.6986 89.1321 8.01953C88.6617 8.32504 88.181 8.72619 87.8434 9.16485C87.7039 9.34623 87.4526 9.69253 87.3476 9.89094L87.1018 10.3699C87.008 10.551 86.8958 10.8703 86.8283 11.0673C86.5271 11.948 86.3764 13.0537 86.3764 14.009ZM123.575 21.6492H126.525C126.681 21.4226 126.791 21.1553 126.933 20.9076L127.634 19.6106C127.674 19.5327 127.704 19.4935 127.742 19.4181C128.13 18.663 128.555 17.9267 128.947 17.1746C128.984 17.1034 129.011 17.0684 129.049 16.9939C129.083 16.9267 129.108 16.8715 129.145 16.8071C129.218 16.681 129.278 16.5501 129.352 16.4306L129.961 15.3059C130.185 14.8661 130.44 14.4353 130.668 13.9976C130.93 13.4946 131.214 13.0072 131.472 12.502L131.669 12.134C131.96 11.5648 132.289 11.0159 132.581 10.4459C132.666 10.2802 132.949 9.82039 132.983 9.68075C133.096 9.80832 133.821 11.2525 133.991 11.5375C134.063 11.6592 134.119 11.7923 134.195 11.9163C134.38 12.2173 134.624 12.7559 134.803 13.0418C134.992 13.3443 135.217 13.8431 135.41 14.1675C135.619 14.5185 135.816 14.9304 136.017 15.294L137.521 18.1036C137.748 18.5498 138.009 18.9788 138.235 19.4236L139.038 20.919C139.089 21.0192 139.394 21.6492 139.476 21.6492H142.39C142.495 21.6492 142.367 21.4797 142.342 21.4328C142.315 21.3805 142.304 21.3697 142.276 21.3218L141.425 19.7158C140.918 18.7268 140.366 17.7606 139.86 16.7718C139.772 16.5999 139.686 16.4513 139.602 16.287C139.56 16.2052 139.518 16.1235 139.476 16.0416L138.427 14.0672C137.962 13.161 137.453 12.2756 136.988 11.3688C136.65 10.71 136.283 10.0656 135.944 9.40622C135.655 8.8416 135.32 8.29384 134.91 7.80325C134.679 7.52717 134.377 7.21594 134.077 7.00852C133.706 6.7525 133.274 6.72329 132.97 6.73003C132.608 6.7381 132.322 6.82723 132.072 6.96423C131.811 7.10771 131.499 7.33363 131.296 7.54706C131.049 7.80759 130.845 8.10576 130.644 8.40155L130.224 9.11409C130.181 9.19886 130.146 9.27837 130.097 9.35793C129.996 9.52181 129.929 9.69541 129.834 9.8552C129.599 10.2482 129.276 10.9584 129.054 11.3205C128.856 11.6416 128.729 11.9816 128.532 12.3018C128.431 12.4658 128.364 12.6393 128.269 12.7991C128.035 13.1921 127.711 13.9023 127.489 14.2645C127.291 14.5855 127.164 14.9255 126.967 15.2458C126.77 15.5668 126.642 15.9068 126.445 16.2271C126.345 16.391 126.278 16.5645 126.182 16.7243C125.948 17.1173 125.625 17.8275 125.402 18.1897C125.205 18.5107 125.077 18.8507 124.88 19.171C124.683 19.4921 124.556 19.832 124.359 20.1523L123.575 21.6492ZM29.1395 9.1901H36.8023V21.5966C36.8023 21.637 36.8148 21.6492 36.8562 21.6492H39.3206C39.362 21.6492 39.3745 21.637 39.3745 21.5966V9.1901H47.0013C47.0428 9.1901 47.0553 9.1779 47.0553 9.13755V6.68426H29.1395V9.1901ZM149.837 13.7637V21.5966C149.837 21.637 149.85 21.6492 149.891 21.6492H152.355C152.418 21.6492 152.41 21.6062 152.411 21.546L152.409 18.9155C152.409 18.6338 152.387 14.8053 152.421 14.7213L154.313 12.7097C154.369 12.6412 154.431 12.6017 154.488 12.5297C154.55 12.4514 154.595 12.4174 154.663 12.349L155.174 11.7963C155.208 11.7625 155.231 11.7426 155.265 11.7094L155.524 11.4357C155.718 11.198 156.187 10.757 156.382 10.5193L157.072 9.79011C157.105 9.75867 157.132 9.73553 157.162 9.70253L159.312 7.416C159.423 7.29308 159.552 7.17876 159.663 7.05651L160 6.68426H156.744C156.439 6.68406 156.51 6.66283 156.361 6.8368C156.318 6.88722 156.273 6.92061 156.227 6.9688C156.193 7.00448 156.194 7.01182 156.163 7.04708L153.745 9.59728C153.694 9.65022 153.676 9.68322 153.619 9.73778C153.434 9.91491 153.163 10.2349 152.962 10.4296C152.907 10.4828 152.89 10.5183 152.837 10.5704L152.45 10.9817C152.324 11.1206 152.177 11.2423 152.06 11.3906L151.407 12.0862C151.222 12.2728 151.06 12.4508 150.875 12.6375C150.606 12.9103 150.241 13.3346 149.968 13.6107C149.932 13.6466 149.837 13.7112 149.837 13.7637ZM148.452 13.1504C148.539 13.0934 148.98 12.6079 149.113 12.48L150.233 11.363C150.123 11.2038 150.057 11.1856 149.963 11.0651L148.294 9.32612C148.26 9.29044 148.261 9.28309 148.231 9.24784L146.343 7.28429C146.21 7.13665 145.829 6.75711 145.79 6.68426H142.282C142.333 6.77726 142.654 7.07732 142.754 7.1882L144.391 8.90535C144.468 8.97999 144.513 9.04182 144.589 9.11567C144.626 9.15168 144.652 9.1755 144.688 9.21165C144.732 9.2551 144.739 9.27406 144.778 9.31702C144.908 9.46054 145.109 9.64503 145.255 9.81576C145.289 9.85519 145.325 9.88492 145.363 9.9217L146.028 10.623C146.068 10.6622 146.096 10.6883 146.136 10.7275L147.872 12.5412C147.912 12.5838 147.919 12.6037 147.961 12.6469C147.998 12.6836 148.024 12.707 148.061 12.7429C148.135 12.8151 148.176 12.8742 148.249 12.9445C148.287 12.9802 148.313 13.0039 148.349 13.0405C148.389 13.0811 148.407 13.1208 148.452 13.1504Z" fill="black"/>
// </svg>`;

export interface EmailParams {
  [value: string]: unknown;
}

export interface EmailData extends SendMailOptions {
  data: EmailParams;
  to: string;
}

export enum EmailTemplateType {
  TRANSACTION_CREATED = 'transaction-created',
  TRANSACTION_COMPLETED = 'transaction-completed',
  TRANSACTION_REPROVED = 'transaction-reproved',
  TRANSACTION_SIGNED = 'transaction-signed',
  VAULT_CREATED = 'vault-created',
}

const transporter = nodemailer.createTransport({
  //TODO: Change host to aws
  host: 'smtp.gmail.com',
  // host: 'email-smtp.sa-east-1.amazonaws.com',
  port: 587,
  auth: {
    user: AWS_SMTP_USER,
    pass: AWS_SMTP_PASS,
  },
});

export const renderTemplate = (
  templateName: EmailTemplateType,
  data: EmailParams,
) => {
  return new Promise<string>((resolve, reject) => {
    fs.readFile(
      path.join(__dirname, '../templates/', `${templateName}.html`),
      (err, file) => {
        if (err) return reject(err);
        const compiledTemplate = handlebars.compile(file.toString());
        resolve(
          compiledTemplate({
            // logo: LOGO,
            // bank: BANK,
            // year: YEAR,
            // color: process.env.APP_COLOR,
            ...data,
          }),
        );
      },
    );
  });
};

export const getSubject = (html: string) => {
  const $ = cheerio.load(html);
  const subject = $('title').text();
  return subject;
};

export const sendMail = async (
  templateName: EmailTemplateType,
  emailData: EmailData,
) => {
  const html = await renderTemplate(templateName, emailData.data);

  return transporter.sendMail({
    from: EMAIL_FROM,
    subject: getSubject(html),
    html,
    to: emailData.to,
  });
};
